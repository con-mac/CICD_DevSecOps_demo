name: DevSecOps CI/CD Pipeline  

on:
  push:
    branches:
      - master  # Trigger when pushing to master branch

jobs:
  build_and_scan:
    name: Build, Security Scan, and Deploy  # Name displayed in GitHub Actions UI
    runs-on: ubuntu-latest  

    steps:

      ## 1. Compile (Source) Stage

      # Checkout latest version of the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      ## 2. Build Stage

      # Set up Docker Buildx for multi-platform builds and caching
      - name: Set Up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Build Docker Nginx image
      - name: Build Docker Image
        run: |
          docker build -t devsecops-nginx .

      ## 3. Test & Security Scan Stage      

      # Security Scan using Trivy (SAST & Dependency scanning)
      - name: Scan for Vulnerabilities (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "devsecops-nginx"  # Scan the built Docker image
          format: "table"  # Output format
          exit-code: 0  # Allow vulnerabilities, do not break pipeline
          severity: "CRITICAL,HIGH"  

      ## Authenticate with Docker Hub (Required for Docker Scout)
      - name: Docker Hub Login
        run: |
          echo "üîë Logging into Docker Hub..."
          echo "${{ secrets.DOCKER_PAT }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Install Docker Scout before running SBOM and security scan
      - name: Install Docker Scout
        run: |
          echo "üîΩ Installing Docker Scout..."
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh -o install.sh
          chmod +x install.sh
          ./install.sh
          
          echo "‚úÖ Verifying Docker Scout Installation..."
          docker scout quickview --help

      # Generate SBOM (Software Bill of Materials) for Dependency check
      - name: Generate SBOM (Software Bill of Materials)
        run: |
          echo "üîç Generating SBOM with Docker Scout..." 
          docker scout quickview devsecops-nginx > sbom.json 
          cat sbom.json  

      # Run Docker Scout Security Scan and store reports
      - name: Run Docker Scout Security Scan
        run: |
          echo "üõ°Ô∏è Running Docker Scout Security Scan..."
          docker scout cves devsecops-nginx --format markdown -o vulnerabilities_report.md || echo "‚ö†Ô∏è Vulnerabilities detected, but continuing pipeline..."
          docker scout cves devsecops-nginx --format json -o vulnerabilities_report.json || echo "‚ö†Ô∏è Vulnerabilities detected, but continuing pipeline..."
          cat vulnerabilities_report.md

      ## OWASP ZAP Dynamic Application Security Testing (DAST)
      - name: Run OWASP ZAP Security Scan (DAST)
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: "http://localhost:8080"  # This tests the live running application for vulnerabilities

      ## 4. Deploy/Release Stage
    
      - name: Deploy Application (Placeholder)
        run: echo "Deployment step to be implemented (Terraform/Kubernetes etc.)"
